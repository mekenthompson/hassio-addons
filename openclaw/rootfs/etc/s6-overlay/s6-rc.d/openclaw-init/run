#!/command/with-contenv bashio
# ==============================================================================
# OpenClaw Init Script (Multi-Agent: Multi-Agent)
# Initializes configuration, workspaces, and utilities
# ==============================================================================

SCRIPT_VERSION="2.0.0"

bashio::log.info "Initializing OpenClaw (multi-agent) v${SCRIPT_VERSION}..."

# ---- Persistent directories ----
# Ken (primary agent)
mkdir -p /data/openclaw-config /data/openclaw-workspace /data/openclaw-home
mkdir -p /data/openclaw-config/credentials

# Lisa (second agent)
mkdir -p /data/openclaw-workspace-lisa

# OpenClaw expects config at ~/.openclaw - symlink to persistent storage
rm -rf /home/node/.openclaw
ln -sf /data/openclaw-config /home/node/.openclaw

# Create workspace symlinks (remove first to avoid mkdir/ln-sf conflict on fresh install)
rm -rf /data/openclaw-config/workspace
ln -sf /data/openclaw-workspace /data/openclaw-config/workspace

chown -R node:node /data/openclaw-config /data/openclaw-workspace /data/openclaw-home
chown -R node:node /data/openclaw-workspace-lisa
chown -h node:node /home/node/.openclaw

# ---- Persistent home directories ----
for dir in .config .local .railway; do
    if [ -d "/data/openclaw-home/$dir" ]; then
        rm -rf "/home/node/$dir"
        ln -sf "/data/openclaw-home/$dir" "/home/node/$dir"
        chown -h node:node "/home/node/$dir"
        bashio::log.info "Linked ~/$dir -> /data/openclaw-home/$dir"
    fi
done

# Ensure persistent bin dir is on PATH
if [ -d "/data/openclaw-home/bin" ]; then
    export PATH="/data/openclaw-home/bin:$PATH"
fi

# ---- Install/update utility scripts ----
# Always overwrite to pick up fixes (versioned by SCRIPT_VERSION)
mkdir -p /data/openclaw-home/bin

# ha-admin: proxy ha CLI commands through HA SSH add-on
cat > /data/openclaw-home/bin/ha-admin << 'SCRIPTEOF'
#!/bin/bash
# ha-admin v2.0.0 — Proxy ha CLI commands through HA SSH add-on
SSH_KEY="/data/openclaw-config/credentials/ha-ssh-key.pem"
SSH_HOST="a0d7b954-ssh.local.hass.io"

if [ ! -f "$SSH_KEY" ]; then
    echo "Error: SSH key not found at $SSH_KEY"
    echo "Generate one with: ssh-keygen -t ed25519 -f $SSH_KEY -N ''"
    exit 1
fi

if [ $# -eq 0 ]; then
    echo "Usage: ha-admin <command> [args...]"
    echo "Example: ha-admin host info"
    exit 1
fi

exec ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
    root@"$SSH_HOST" ha "$@"
SCRIPTEOF

# ha-api: thin wrapper for HA REST API calls
cat > /data/openclaw-home/bin/ha-api << 'SCRIPTEOF'
#!/bin/bash
# ha-api v2.0.0 — Thin wrapper for HA REST API calls
HA_URL="http://homeassistant.local.hass.io:8123"
TOKEN_FILE="/data/openclaw-config/credentials/ha-access-token"

if [ ! -f "$TOKEN_FILE" ]; then
    echo "Error: HA access token not found at $TOKEN_FILE"
    exit 1
fi

if [ $# -lt 2 ]; then
    echo "Usage: ha-api METHOD endpoint [curl-args...]"
    echo "Example: ha-api GET states/sensor.temperature"
    echo "Example: ha-api POST services/light/turn_on -d '{\"entity_id\":\"light.lounge\"}'"
    exit 1
fi

HA_TOKEN=$(cat "$TOKEN_FILE")
METHOD="$1"
ENDPOINT="$2"
shift 2
curl -s -X "$METHOD" \
    -H "Authorization: Bearer $HA_TOKEN" \
    -H "Content-Type: application/json" \
    "$HA_URL/api/$ENDPOINT" "$@"
SCRIPTEOF

# backup-secrets: age-encrypt credentials for disaster recovery
cat > /data/openclaw-home/bin/backup-secrets << 'SCRIPTEOF'
#!/bin/bash
# backup-secrets v2.0.0 — Age-encrypt credentials for disaster recovery
AGE_RECIPIENT=$(cat /data/openclaw-config/credentials/age-recipient.txt 2>/dev/null)
if [ -z "$AGE_RECIPIENT" ]; then
    echo "Error: No age recipient key found at /data/openclaw-config/credentials/age-recipient.txt"
    exit 1
fi
BACKUP_DIR="/share/backups/openclaw"
DATE=$(date +%Y-%m-%d)

mkdir -p "$BACKUP_DIR"

# Archive both Ken's and Lisa's credentials
tar -cf - \
    -C / \
    data/openclaw-config/credentials/ \
    data/openclaw-config/gateway.token \
    2>/dev/null \
    | age -r "$AGE_RECIPIENT" -o "$BACKUP_DIR/secrets-$DATE.tar.age"

find "$BACKUP_DIR" -name "secrets-*.tar.age" -mtime +14 -delete
echo "Backup complete: $BACKUP_DIR/secrets-$DATE.tar.age"
SCRIPTEOF

chmod +x /data/openclaw-home/bin/ha-admin /data/openclaw-home/bin/ha-api /data/openclaw-home/bin/backup-secrets
bashio::log.info "Utility scripts installed (v${SCRIPT_VERSION})"

# ---- Gateway token ----
GATEWAY_TOKEN=$(bashio::config 'gateway_token')
if [ -z "$GATEWAY_TOKEN" ]; then
    if [ -f /data/openclaw-config/gateway.token ]; then
        GATEWAY_TOKEN=$(cat /data/openclaw-config/gateway.token)
        bashio::log.info "Using existing gateway token"
    else
        bashio::log.info "Generating gateway token..."
        GATEWAY_TOKEN=$(openssl rand -hex 32)
        echo "$GATEWAY_TOKEN" > /data/openclaw-config/gateway.token
        bashio::log.info "Gateway token generated and saved"
    fi
else
    echo "$GATEWAY_TOKEN" > /data/openclaw-config/gateway.token
fi

# ---- Read addon configuration ----
TELEGRAM_BOT_TOKEN=$(bashio::config 'telegram_bot_token')
TELEGRAM_USER_ID=$(bashio::config 'telegram_user_id')
CLAUDE_SESSION_KEY=$(bashio::config 'claude_session_key')
LOG_LEVEL=$(bashio::config 'log_level')

LISA_TELEGRAM_BOT_TOKEN=$(bashio::config 'lisa_telegram_bot_token')
LISA_TELEGRAM_USER_ID=$(bashio::config 'lisa_telegram_user_id')

# ---- Bootstrap openclaw.json (first run only) ----
if [ -f /data/openclaw-config/openclaw.json ]; then
    bashio::log.info "OpenClaw configuration already exists, preserving it"
else
    bashio::log.info "Creating initial multi-agent OpenClaw configuration..."

    # Build Ken's Telegram account
    # Default to "pairing" if no user ID (avoids empty allowlist lockout)
    TELEGRAM_ACCOUNTS=""
    if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
        if [ -n "$TELEGRAM_USER_ID" ]; then
            TELEGRAM_ACCOUNTS="\"default\": { \"botToken\": \"$TELEGRAM_BOT_TOKEN\", \"dmPolicy\": \"allowlist\", \"allowFrom\": [\"$TELEGRAM_USER_ID\"] }"
        else
            TELEGRAM_ACCOUNTS="\"default\": { \"botToken\": \"$TELEGRAM_BOT_TOKEN\", \"dmPolicy\": \"pairing\" }"
        fi
    fi

    # Build Lisa's Telegram account
    if [ -n "$LISA_TELEGRAM_BOT_TOKEN" ]; then
        if [ -n "$TELEGRAM_ACCOUNTS" ]; then
            TELEGRAM_ACCOUNTS="$TELEGRAM_ACCOUNTS, "
        fi
        if [ -n "$LISA_TELEGRAM_USER_ID" ]; then
            TELEGRAM_ACCOUNTS="${TELEGRAM_ACCOUNTS}\"lisa\": { \"botToken\": \"$LISA_TELEGRAM_BOT_TOKEN\", \"dmPolicy\": \"allowlist\", \"allowFrom\": [\"$LISA_TELEGRAM_USER_ID\"] }"
        else
            TELEGRAM_ACCOUNTS="${TELEGRAM_ACCOUNTS}\"lisa\": { \"botToken\": \"$LISA_TELEGRAM_BOT_TOKEN\", \"dmPolicy\": \"pairing\" }"
        fi
    fi

    # Build bindings
    BINDINGS="{ \"agentId\": \"main\", \"match\": { \"channel\": \"telegram\", \"accountId\": \"default\" } }"
    if [ -n "$LISA_TELEGRAM_BOT_TOKEN" ]; then
        BINDINGS="$BINDINGS, { \"agentId\": \"lisa\", \"match\": { \"channel\": \"telegram\", \"accountId\": \"lisa\" } }"
    fi

    # Build agents list
    AGENTS_LIST="{ \"id\": \"main\", \"default\": true, \"workspace\": \"/data/openclaw-workspace\" }"
    if [ -n "$LISA_TELEGRAM_BOT_TOKEN" ]; then
        AGENTS_LIST="$AGENTS_LIST, { \"id\": \"lisa\", \"workspace\": \"/data/openclaw-workspace-lisa\" }"
    fi

    # Build agentToAgent (only if multi-agent)
    AGENT_TO_AGENT=""
    if [ -n "$LISA_TELEGRAM_BOT_TOKEN" ]; then
        AGENT_TO_AGENT="\"tools\": { \"agentToAgent\": { \"enabled\": true, \"allow\": [\"main\", \"lisa\"] } },"
    fi

    # Build providers section
    PROVIDERS=""
    if [ -n "$CLAUDE_SESSION_KEY" ]; then
        PROVIDERS="\"providers\": { \"anthropic\": { \"sessionKey\": \"$CLAUDE_SESSION_KEY\" } },"
    fi

    cat > /data/openclaw-config/openclaw.json <<JSONEOF
{
  "channels": {
    "telegram": {
      "accounts": {
        $TELEGRAM_ACCOUNTS
      }
    }
  },
  "bindings": [ $BINDINGS ],
  "gateway": {
    "mode": "local",
    "port": 18800,
    "bind": "lan",
    "auth": { "token": "$GATEWAY_TOKEN" },
    "trustedProxies": ["172.30.32.0/24", "172.30.33.0/24", "127.0.0.1"],
    "controlUi": {
      "enabled": true,
      "allowInsecureAuth": true,
      "allowedOrigins": ["*"]
    }
  },
  $PROVIDERS
  $AGENT_TO_AGENT
  "agents": {
    "defaults": {
      "model": {
        "primary": "anthropic/claude-opus-4-6"
      }
    },
    "list": [ $AGENTS_LIST ]
  },
  "logging": { "level": "$LOG_LEVEL" }
}
JSONEOF

    chown node:node /data/openclaw-config/openclaw.json
    bashio::log.info "Initial multi-agent configuration written"
fi

chown node:node /data/openclaw-config/gateway.token

# ---- Sync gateway token (can drift between addon config and openclaw.json) ----
if [ -f /data/openclaw-config/openclaw.json ]; then
    CURRENT_TOKEN=$(jq -r '.gateway.auth.token // empty' /data/openclaw-config/openclaw.json 2>/dev/null)
    if [ "$CURRENT_TOKEN" != "$GATEWAY_TOKEN" ]; then
        bashio::log.info "Syncing gateway token to openclaw.json..."
        jq --arg token "$GATEWAY_TOKEN" '.gateway.auth.token = $token' \
            /data/openclaw-config/openclaw.json > /tmp/oc-token-sync.json \
            && mv /tmp/oc-token-sync.json /data/openclaw-config/openclaw.json
        chown node:node /data/openclaw-config/openclaw.json
    fi
fi

# ---- Logging ----
bashio::log.info "Gateway mode: local"
bashio::log.info "Ken Telegram: $([ -n "$TELEGRAM_BOT_TOKEN" ] && echo 'configured' || echo 'not set')"
bashio::log.info "Lisa Telegram: $([ -n "$LISA_TELEGRAM_BOT_TOKEN" ] && echo 'configured' || echo 'not set')"

# ---- nginx proxy config ----
bashio::log.info "Generating nginx proxy configuration..."
cat > /etc/nginx/nginx.conf <<'NGINXEOF'
worker_processes 1;
error_log /dev/stderr warn;
pid /tmp/nginx.pid;
daemon off;

events {
    worker_connections 128;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    access_log off;
    proxy_buffers 16 64k;
    proxy_buffer_size 64k;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
        listen 18789;
        server_name _;

        location / {
            proxy_pass http://127.0.0.1:18800;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;

            proxy_set_header Origin http://$host;
            proxy_set_header Accept-Encoding "";

            proxy_hide_header Content-Security-Policy;
            proxy_hide_header X-Frame-Options;
NGINXEOF

cat >> /etc/nginx/nginx.conf <<NGINXEOF
            sub_filter '</head>' '<script>(function(){var p=location.pathname;if(p.indexOf("/hassio/ingress/")===0||p.indexOf("/api/hassio_ingress/")===0){var proto=location.protocol==="https:"?"wss":"ws";var gw=proto+"://"+location.hostname+":18789";var k="openclaw.control.settings.v1";var s;try{s=JSON.parse(localStorage.getItem(k)||"{}")}catch(e){s={}}var changed=false;if(s.gatewayUrl!==gw){s.gatewayUrl=gw;changed=true}if(s.token!=="${GATEWAY_TOKEN}"){s.token="${GATEWAY_TOKEN}";changed=true}if(changed){localStorage.setItem(k,JSON.stringify(s));location.reload()}}})();</script></head>';
NGINXEOF

cat >> /etc/nginx/nginx.conf <<'NGINXEOF'
            sub_filter_once on;
            sub_filter_types text/html;
        }
    }
}
NGINXEOF

bashio::log.info "nginx configuration generated"

# ---- Ensure allowedOrigins for HA ingress ----
if [ -f /data/openclaw-config/openclaw.json ]; then
    if ! jq -e '.gateway.controlUi.allowedOrigins' /data/openclaw-config/openclaw.json > /dev/null 2>&1; then
        bashio::log.info "Adding allowedOrigins to controlUi config..."
        jq '.gateway.controlUi.allowedOrigins = ["*"]' \
            /data/openclaw-config/openclaw.json > /tmp/oc-patch.json \
            && mv /tmp/oc-patch.json /data/openclaw-config/openclaw.json
        chown node:node /data/openclaw-config/openclaw.json
    fi
fi

# ---- Doctor check ----
bashio::log.info "Running openclaw doctor --fix..."
cd /app && su - node -s /bin/bash -c "cd /app && HOME=/home/node node dist/index.js doctor --fix" || {
    bashio::log.warning "openclaw doctor --fix had warnings, continuing..."
}

# ---- Playwright Chromium ----
if [ ! -d "/data/openclaw-home/.cache/ms-playwright" ]; then
    bashio::log.info "Installing Chromium for Playwright (first run)..."
    su - node -c "cd /app && PLAYWRIGHT_BROWSERS_PATH=/data/openclaw-home/.cache/ms-playwright node node_modules/playwright-core/cli.js install chromium" || {
        bashio::log.warning "Playwright Chromium installation failed, but continuing..."
    }
else
    bashio::log.info "Playwright Chromium already installed, skipping..."
fi

# ---- Additional packages ----
if bashio::config.has_value 'additional_packages'; then
    bashio::log.info "Installing additional packages..."
    PACKAGES=$(bashio::config 'additional_packages | join(" ")')
    if [ -n "$PACKAGES" ]; then
        apt-get update
        # shellcheck disable=SC2086
        apt-get install -y --no-install-recommends $PACKAGES
        apt-get clean
        rm -rf /tmp/* /var/cache/* /var/lib/apt/lists/*
    fi
fi

bashio::log.info "OpenClaw initialization complete! (multi-agent: Multi-Agent)"
