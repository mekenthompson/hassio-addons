#!/command/with-contenv bashio
# ==============================================================================
# Persist all user config across reboots
# Symlinks ~/.config, ~/.local, and ~/.bun to /data/openclaw-home so any CLI
# that stores config there (gh, railway, docker, gcloud, bun, qmd, etc.) persists.
# ==============================================================================

bashio::log.info "Setting up persistent config symlinks..."

# Ensure persistent dirs exist
mkdir -p /data/openclaw-home/.config /data/openclaw-home/.local/bin /data/openclaw-home/.bun

# Clean broken symlinks in persistent bun bin (prevents stale qmd EACCES)
find /data/openclaw-home/.bun/bin -xtype l -delete 2>/dev/null || true

# Replace ephemeral dirs with symlinks to persistent storage
rm -rf /home/node/.config /home/node/.local /home/node/.bun
ln -sf /data/openclaw-home/.config /home/node/.config
ln -sf /data/openclaw-home/.local /home/node/.local
ln -sf /data/openclaw-home/.bun /home/node/.bun

# Fix ownership
chown -R node:node /data/openclaw-home

# Install bun + qmd into persistent storage if not present
# This matches the production pattern: node user owns everything in .bun/
if [ ! -x /data/openclaw-home/.bun/bin/bun ]; then
    bashio::log.info "Installing bun into persistent storage (first run)..."
    su - node -s /bin/bash -c "curl -fsSL https://bun.sh/install | bash" || {
        bashio::log.warning "Bun installation failed — qmd memory search will be unavailable"
    }
fi

if [ -x /data/openclaw-home/.bun/bin/bun ] && ! su - node -s /bin/bash -c "command -v qmd" >/dev/null 2>&1; then
    bashio::log.info "Installing qmd into persistent storage (first run, may take 1-2 min)..."
    su - node -s /bin/bash -c "/home/node/.bun/bin/bun install -g https://github.com/tobi/qmd" || {
        bashio::log.warning "qmd installation failed — memory search will be unavailable"
    }
fi

# Ensure qmd command resolves to the persistent install
if [ -f /data/openclaw-config/openclaw.json ] && [ -x /home/node/.bun/bin/qmd ]; then
    if jq -e '.memory.backend == "qmd"' /data/openclaw-config/openclaw.json >/dev/null 2>&1; then
        bashio::log.info "Setting qmd command to /home/node/.bun/bin/qmd..."
        jq '.memory.qmd.command = "/home/node/.bun/bin/qmd"' \
            /data/openclaw-config/openclaw.json > /tmp/oc-patch.json \
            && mv /tmp/oc-patch.json /data/openclaw-config/openclaw.json
        chown node:node /data/openclaw-config/openclaw.json
    fi
fi

bashio::log.info "Persistent config symlinks ready (~/.config, ~/.local, ~/.bun)"
