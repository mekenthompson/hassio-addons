#!/command/with-contenv bashio
# ==============================================================================
# Persist all user config across reboots
# Symlinks ~/.config, ~/.local, and ~/.bun to /data/openclaw-home so any CLI
# that stores config there (gh, railway, docker, gcloud, bun, qmd, etc.) persists.
# ==============================================================================

bashio::log.info "Setting up persistent config symlinks..."

# Ensure persistent dirs exist
mkdir -p /data/openclaw-home/.config /data/openclaw-home/.local/bin /data/openclaw-home/.bun

# Copy image bun directory contents to persistent storage before symlinking (preserves qmd)
if [ -d "/home/node/.bun" ] && [ "$(ls -A /home/node/.bun 2>/dev/null)" ]; then
    cp -an /home/node/.bun/* /data/openclaw-home/.bun/ 2>/dev/null || true
fi

# Replace ephemeral dirs with symlinks to persistent storage
rm -rf /home/node/.config /home/node/.local /home/node/.bun
ln -sf /data/openclaw-home/.config /home/node/.config
ln -sf /data/openclaw-home/.local /home/node/.local
ln -sf /data/openclaw-home/.bun /home/node/.bun

# Fix ownership
chown -R node:node /data/openclaw-home

bashio::log.info "Persistent config symlinks ready (~/.config, ~/.local, ~/.bun)"
