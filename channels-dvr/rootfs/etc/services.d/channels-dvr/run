#!/command/with-contenv bashio

bashio::log.info "Starting Channels DVR Server..."

# Define paths
SEED_DIR="/opt/channels-dvr"
BINARY_DIR="/media/dvr/channels-dvr-server"
DATA_DIR="/media/dvr/channels-dvr-data"

# Ensure binary directory is initialized
if [ ! -d "$BINARY_DIR/latest" ]; then
    bashio::log.info "First run detected. Initializing binary storage at $BINARY_DIR..."
    mkdir -p "$BINARY_DIR"
    cp -a "$SEED_DIR/." "$BINARY_DIR/"
    bashio::log.info "Binary initialization complete."
else
    bashio::log.info "Found existing binary at $BINARY_DIR"
fi

# Ensure data directory exists
mkdir -p "$DATA_DIR"
bashio::log.info "Using data directory: $DATA_DIR"

# Auto-restore database from backup if missing or empty
# The backup settings.db is ~60KB; a fresh/empty one is much smaller
SETTINGS_SIZE=0
if [ -f "$DATA_DIR/settings.db" ]; then
    SETTINGS_SIZE=$(stat -c%s "$DATA_DIR/settings.db" 2>/dev/null || echo 0)
fi
if [ "$SETTINGS_SIZE" -lt 50000 ]; then
    bashio::log.warning "Database missing or empty in $DATA_DIR (size: ${SETTINGS_SIZE}B)! Attempting restore from backup..."
    BACKUP_BASE="/share/channels-dvr/Database"
    if [ -d "$BACKUP_BASE" ]; then
        LATEST_BACKUP=$(ls -td "$BACKUP_BASE"/backup-*/ 2>/dev/null | head -1)
        if [ -n "$LATEST_BACKUP" ] && [ -f "$LATEST_BACKUP/settings.db" ]; then
            bashio::log.info "Restoring from backup: $LATEST_BACKUP"
            cp "$LATEST_BACKUP/settings.db" "$DATA_DIR/"
            [ -f "$LATEST_BACKUP/recorder.db" ] && cp "$LATEST_BACKUP/recorder.db" "$DATA_DIR/"
            bashio::log.info "Database restored successfully."
        else
            bashio::log.warning "No valid backup found in $BACKUP_BASE"
        fi
    else
        bashio::log.warning "No backup directory found at $BACKUP_BASE"
    fi
else
    bashio::log.info "Database found in $DATA_DIR"
fi

# Create default recordings directory if it doesn't exist
if [ -d "/share" ]; then
    mkdir -p "/share/channels-dvr"
fi

if [ -d "/media" ]; then
    mkdir -p "/media/dvr"
fi

# Start Channels DVR Server with explicit data path
cd "$BINARY_DIR/latest"

bashio::log.info "Starting Channels DVR binary from $(pwd) with data path $DATA_DIR"
exec ./channels-dvr -dir "$DATA_DIR"
